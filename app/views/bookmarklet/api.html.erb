<%
	callback_protocol = request.protocol;
	callback_host = Rails.env.production? ? 'amplifize.com' : "#{request.host}:#{request.port}";
%>
/**
 * Copyright (C) 2012-2013 Big Fish Big Pond
 * All Rights Reserved
 */

(function(){

	// the minimum version of jQuery we want
	var v = "1.8.3";

	// check prior inclusion and version
	if (window.jQuery === undefined || window.jQuery.fn.jquery < v) {
		var done = false;
		var script = document.createElement("script");
		script.src = "http://ajax.googleapis.com/ajax/libs/jquery/" + v + "/jquery.min.js";
		script.onload = script.onreadystatechange = function(){
			if (!done && (!this.readyState || this.readyState == "loaded" || this.readyState == "complete")) {
				done = true;
				initAmplifizeBookmarklet();
			}
		};
		document.getElementsByTagName("head")[0].appendChild(script);
	} else {
		initAmplifizeBookmarklet();
	}
	
	function initAmplifizeBookmarklet() {
		(window.amplifizeBookmarklet = function() {
			//draw the popup

			// Main Overlay
			var overlay = document.createElement('div');
			overlay.setAttribute('id', 'amplifizeShareOverlay');
			overlay.setAttribute('style', 'background-color: rgba(0, 0, 0, 0.9);height: 100%;position: fixed;top: 0;left:0;width: 100%;z-index: 10000000;');

			// Form Container
			var form_container = document.createElement('div');
			form_container.setAttribute('id', 'ampformcontainer');
			form_container.setAttribute('style', 'left: 50%;margin-left: -300px;margin-top: -100px;position: fixed;top: 50%;width: 600px;');

			// Header Container
			var header_container = document.createElement('div');
			header_container.setAttribute('style', 'font-size: 2.2em;text-align:center;padding:12px;color:#ccc;');
			header_container.setAttribute('id', 'headerContainer');
			header_container.innerHTML = 'Share on Amplifize';

			// Label Container
			var label_container = document.createElement('div');
			label_container.setAttribute('style', 'font-size:0.8em;font-style:italic;color:#ccc;');
			label_container.innerHTML = "Comment:";

			// Textarea Container
			var ta = document.createElement('textarea');
			ta.setAttribute('style', 'width:100%;height:70px;font-family:helvetica,arial,sans-serif;');
			ta.setAttribute('name', 'summary');
			ta.setAttribute('id', 'amplifizeShareComment');

			var ta_container = document.createElement('div');
			ta_container.appendChild(ta);

			// Button Container
			var btn_container = document.createElement('div');
			btn_container.setAttribute('style', 'text-align:center;padding:5px;');

			var submit_btn = document.createElement('button');
			submit_btn.setAttribute("style", "margin-right:10px;height: 30px;color: #fff; padding: 5px; width: 100px; font-size: 15px; background-color: #3AAADB; border-radius: 12px;-moz-border-radius: 12px;-webkit-border-radius: 12px; border: 1px solid #3AAADB;");

			var cancel_btn = document.createElement('button');
			cancel_btn.setAttribute("style", "height: 30px;color: #fff; padding: 5px; width: 100px; font-size: 15px; background-color: #7b7165; border-radius: 12px;-moz-border-radius: 12px;-webkit-border-radius: 12px; border: 1px solid #7b7165;");

			btn_container.appendChild(submit_btn);
			btn_container.appendChild(cancel_btn);

			submit_btn.innerHTML = 'Share';
			cancel_btn.innerHTML = 'Cancel';

			cancel_btn.onclick = function() {
				overlay.style.display = 'none';
			};

			submit_btn.onclick = function() {
				window.jQuery("#headerContainer").html('Sharing...');
	
				shareContent();
	
				label_container.style.display = 'none';
				ta.style.display = 'none';
				btn_container.style.display = 'none';
			};
	
			form_container.appendChild(header_container);
			form_container.appendChild(label_container);
			form_container.appendChild(ta_container);
			form_container.appendChild(btn_container);
	
			overlay.appendChild(form_container);
	
			document.body.appendChild(overlay);
		})();
	}

	function shareContent() {
		var fetch = 1;
		/*
		var docContent = window.jQuery(document.body).clone().remove('script').remove('noscript').remove('iframe');
		removeHiddenNodes(docContent);
		docContent = docContent.html();
		if(150000 < docContent.length) {
			fetch = 1;
			docContent = '';
		}
		*/

		var data = {
			fetch : fetch,
			url: encodeURIComponent(window.location),
			comment: encodeURIComponent(window.jQuery("#amplifizeShareComment").val()),
			title: encodeURIComponent(document.title),
			content: encodeURIComponent('') //encodeURIComponent(docContent)
		};

		window.jQuery.ajax({
			method: "POST",
			url: "<%= callback_protocol %><%= callback_host %>/ext/share/v1/<%=@current_user.single_access_token%>",
			data: data,
			success: function(data, textStatus, jqXHR) {
				window.jQuery("#headerContainer").html('Conversation started');
				setTimeout(function() {
					window.jQuery("#amplifizeShareOverlay").css("display", 'none');
				}, 1500);
			},
			error: function(jqXHR, textStatus, errorThrown) {
				window.jQuery("#headerContainer").html('Unable to share. Try again.');
				setTimeout(function() {
					window.jQuery("#amplifizeShareOverlay").css("display", 'none');
				}, 1500);
			}
		});
	}
	
	function removeHiddenNodes(node) {
		if(node != null && 1 == node.nodeType) {
			if(node.css("visibility") == "hidden" || node.css("display") == "none") {
				node.parentNode.removeChild(node);
			} else {
				for(var i = 0; i < node.childNodes.length; i++) {
					removeHiddenNodes(node.childNodes[i]);
				}
			}
		}
	}
})();
